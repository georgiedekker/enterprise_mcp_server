services:
  # postgres:
  #   image: postgres:15-alpine
  #   restart: always
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #     POSTGRES_DB: enterprise_mcp_server
  #   ports:
  #   - 5434:5432
  #   volumes:
  #   - postgres_data:/var/lib/postgresql/data
  #   - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
  #   networks:
  #   - workflow-system-network
  redis:
    image: redis:7-alpine
    restart: always
    ports:
    - 6378:6379
    volumes:
    - redis_data:/data
    command: redis-server --port 6379 --appendonly yes
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - workflow-system-network
  mcp:
    build:
      context: .
      dockerfile: Dockerfile
    image: enterprise-mcp-server:latest
    container_name: enterprise-mcp-server
    env_file:
    - .env
    ports:
    - 0.0.0.0:8033:8033
    volumes:
    - ./src:/app/src
    - claude_auth:/root/.claude
    restart: unless-stopped
    depends_on: # postgres is now centralized on m1 pgbouncer
    # - postgres
    - redis
    environment:
    - HOST=0.0.0.0
    - PORT=8033
    - LOG_LEVEL=INFO
    - CORS_ALLOWED_ORIGINS=https://app.cursor.sh,https://cursor.sh,http://localhost:*,http://127.0.0.1:*
    - PYTHONUNBUFFERED=1
    - POSTGRES_HOST=192.168.0.245
    - POSTGRES_PORT=6432
    - POSTGRES_DB=enterprise_mcp_server
    - POSTGRES_USER=enterprise_mcp_server
    - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    - POSTGRES_POOL_MIN_SIZE=2
    - POSTGRES_POOL_MAX_SIZE=10
    - REDIS_URL=redis://redis:6379
    - ENTERPRISE_MCP_SERVER_URL=http://localhost:8033
    - GATEWAY_PORT=8000
    - DEFAULT_RATE_LIMIT=1000
    - CORS_ORIGINS=http://localhost:*,https://app.cursor.sh,https://cursor.sh
    - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    - JWT_ALGORITHM=HS256
    - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=120
    - ADMIN_USERNAME=admin
    - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    - DEFAULT_ADMIN_PASSWORD_HASH=${DEFAULT_ADMIN_PASSWORD_HASH}
    - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    healthcheck:
      test:
      - CMD-SHELL
      - curl -f http://localhost:8033/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
    - workflow-system-network
    extra_hosts:
    - pgbouncer.internal:192.168.0.245
networks:
  workflow-system-network:
    external: true
volumes:
  postgres_data: null
  redis_data: null
  claude_auth: null
